---
title: "Project Data Cleaning"
output:
  html_document:
    df_print: paged
---
```{r setup, include=FALSE}
library(learnr)
knitr::opts_chunk$set(echo = TRUE,   
                      message = FALSE,
                      warning = FALSE,
                      collapse = TRUE,
                      fig.height = 6,
                      fig.width = 6,
                      fig.align = "center",
                      cache = FALSE)
tutorial_html_dependency()
library(tidyverse)
library(plotly)
library(readxl)
library(visdat)
library(foreign)
library(maptools)
library(ggmap)
library(plyr)
library(lubridate)
```

```{r eval = FALSE}
lganames <- read.dbf("data/VIC_LGA_POLYGON_shp.dbf")
lgapoly <- readShapePoly("data/VIC_LGA_POLYGON_shp.shp")

library(RColorBrewer)
colors <- brewer.pal(9, "BuGn")

lgapoly.points <- fortify(lgapoly)
lgamap <- get_map(location = c(lon = 144.7852, lat = -37.4713), zoom=6)
ggmap(lgamap) +
  geom_polygon(aes(x = long,
      y = lat,
      group = group),
    data = lgapoly.points,
    color = colors[9],
    fill = colors[6],
    alpha = 0.5) +
labs(x = "Longitude",
  y = "Latitude")
#oz <- get_map(location=c(lon=133.8807,lat=-23.6980),zoom=4)
```


```{r}
all <- read_xlsx("data/Quarterly median rents by local government area - March quarter 2018.xlsx",sheet = 7)
head(all)
all <- all[,-1]
#all <- all %>% rename("Suburb" = "X__2")
colnames(all)[1] <- "Suburb"

vec1 <- seq(2,ncol(all),2)
vec2 <- seq(3,ncol(all),2)

colnames(all)[vec2] <- colnames(all)[vec1]
colnames(all)[vec1] <- paste(colnames(all)[vec2],"_Count",sep='')
colnames(all)[vec2] <- paste(colnames(all)[vec2],"_Median",sep='')
all <- all[-c(1,90),]

all_f <- all %>% gather(variable, values, -Suburb) %>% arrange(Suburb)
all_f <- all_f %>% separate(variable, c("month","year","type"),by="_")
all_medianp <- all_f %>% filter(type == "Median")
all_counts <- all_f %>% filter(type == "Count")

vis_dat(all)
```

```{r}
# to retrieve the average lat and lon from the files
LGACouncil <- read_csv("data/fileslocalgovt.csv")
LatLon <- read_csv("data/Australian_Post_Codes_Lat_Lon 2.csv")
LatLon <- LatLon[,c(1,2,3,6,7)]


LatLon <- LatLon %>% filter(state == 'VIC')
LatLon <- LatLon %>% mutate(Postcode = postcode)
LatLon <- LatLon[,c(6,2,4,5)]
LGACouncil <- LGACouncil[,c(1,4,7)]

#match the coordinate with the LGA
LGAjoin <- left_join(LGACouncil,LatLon, by='Postcode')
LGA_mod <- LGAjoin %>% group_by(Name) %>% mutate(avg_lat = mean(lat),avg_lon = mean(lon))
LGA <- LGAjoin[!duplicated(LGA_mod$LGA),]
LGA <- LGA[,-c(1,4)]
LGA <- LGA[,c(2,1,3,4)]
LGA <- LGA %>% separate(LGA,sep="[(]",c("LGA","Index"))

# remove trailing whitespace
trim.trailing <- function (x) sub("\\s+$", "", x)
LGA$LGA <- trim.trailing(LGA$LGA)
LGA <- LGA[,-2]
```

```{r eval = FALSE}
all_medianp_2018 <- all_medianp %>% filter(year == 2018)
all_medianp_2018 <- all_medianp_2018 %>% mutate(LGA = Suburb)
all_medianp_2018 <- all_medianp_2018[,c(6,2,3,4,5)]

LGA <- LGA %>% arrange(LGA)
all_medianp_2018 <- all_medianp_2018 %>% arrange(LGA)
loc_2018 <- right_join(LGA,all_medianp_2018,by='LGA')

loc_2018 <- loc_2018 %>% filter(LGA != 'Group Total' & LGA != 'Metro' & LGA != 'Non-Metro' & LGA != 'Victoria')
loc_2018$LGA[loc_2018$LGA  == 'Mornington Penin\'a'] <- "Mornington Peninsula"

vic <- get_map(location=c(lon=144.9460, lat=-37.8150), zoom=9)
m <- ggmap(vic) + 
  geom_point(data=loc_2018, aes(x=lon, y=lat,label = values), 
              alpha=1, colour='red', size=0.5)
ggplotly(m)
```

```{r}
testvar <- all_medianp %>%  
  mutate(date=paste("01-",month,"-",year)) %>% 
  mutate(date=dmy(date)) %>% 
  select("Suburb","values","date") %>%
  mutate(values=as.numeric(values))
#glimpse(testvar)
ticks<-c(100,200,300,400,500,600)
testgraph <- testvar %>% ggplot(aes(x=date,y=values,colour=Suburb,yaxt="n"))+geom_line() #geom_smooth(se=FALSE)#+geom_point()+geom_smooth(se=FALSE)#+scale_y_discrete(limits=600)

ggplotly(testgraph)
```



```{r}
agegroup_2017 <- read_xls("data/2017.xls",sheet = "Table 3") 
agegroup_2017<-agegroup_2017[-c(1:8),-c(1)]
agegroup_2017<-agegroup_2017[,-c(2:6)]
agegroup_2017<-agegroup_2017[,-c(3:4)] 
agegroup_2017<-agegroup_2017 %>%
  select('state'=c(1),'LGA'=c(2),'0-4'=c(3),'5-9'=c(4),'10-14'=c(5),'15-19'=c(6),'20-24'=c(7),'25-29'=c(8),'30-34'=c(9),'35-39'=c(10),'40-44'=c(11),'45-49'=c(12),'50-54'=c(13),'55-59'=c(14),'60-64'=c(15),'65-69'=c(16),'70-74'=c(17),'75-79'=c(18),'80-84'=c(19),'85 and over'=c(20),'pop'=c(21)) %>%
  filter(state=="Victoria")
```

```{r}
agegroup_2016 <- read_xls("data/2006_2016.xls",sheet = "Table 6") 
agegroup_2016<-agegroup_2016[-c(1:8),-c(1)]
agegroup_2016<-agegroup_2016[,-c(2:6)]
agegroup_2016<-agegroup_2016[,-c(3:4)]
agegroup_2016<-agegroup_2016 %>%
  select('state'=c(1),'LGA'=c(2),'0-4'=c(3),'5-9'=c(4),'10-14'=c(5),'15-19'=c(6),'20-24'=c(7),'25-29'=c(8),'30-34'=c(9),'35-39'=c(10),'40-44'=c(11),'45-49'=c(12),'50-54'=c(13),'55-59'=c(14),'60-64'=c(15),'65-69'=c(16),'70-74'=c(17),'75-79'=c(18),'80-84'=c(19),'85 and over'=c(20),'total persons'=c(21))
```

```{r}
agegroup_2006 <- read_xls("data/2006_2016.xls",sheet = "Table 3") 
agegroup_2006<-agegroup_2006[-c(1:8),-c(1)]
agegroup_2006<-agegroup_2006[,-c(2:6)]
agegroup_2006<-agegroup_2006[,-c(3:4)]
agegroup_2006<-agegroup_2006 %>%
  select('state'=c(1),'LGA'=c(2),'0-4'=c(3),'5-9'=c(4),'10-14'=c(5),'15-19'=c(6),'20-24'=c(7),'25-29'=c(8),'30-34'=c(9),'35-39'=c(10),'40-44'=c(11),'45-49'=c(12),'50-54'=c(13),'55-59'=c(14),'60-64'=c(15),'65-69'=c(16),'70-74'=c(17),'75-79'=c(18),'80-84'=c(19),'85 and over'=c(20),'total persons'=c(21))
```

```{r}
agegroup_2015 <- read_xls("data/2010_2015.xls",sheet = "Table 6") 
agegroup_2015<-agegroup_2015[-c(1:7),-c(1)]
agegroup_2015<-agegroup_2015[,-c(2:6)]
agegroup_2015<-agegroup_2015[,-c(3:4)]
agegroup_2015<-agegroup_2015 %>%
  select('state'=c(1),'LGA'=c(2),'0-4'=c(3),'5-9'=c(4),'10-14'=c(5),'15-19'=c(6),'20-24'=c(7),'25-29'=c(8),'30-34'=c(9),'35-39'=c(10),'40-44'=c(11),'45-49'=c(12),'50-54'=c(13),'55-59'=c(14),'60-64'=c(15),'65-69'=c(16),'70-74'=c(17),'75-79'=c(18),'80-84'=c(19),'85 and over'=c(20),'total persons'=c(21))
```

```{r}
agegroup_2010 <- read_xls("data/2010_2015.xls",sheet = "Table 3") 
agegroup_2010<-agegroup_2010[-c(1:7),-c(1)]
agegroup_2010<-agegroup_2010[,-c(2:6)]
agegroup_2010<-agegroup_2010[,-c(3:4)]
agegroup_2010<-agegroup_2010 %>%
  select('state'=c(1),'LGA'=c(2),'0-4'=c(3),'5-9'=c(4),'10-14'=c(5),'15-19'=c(6),'20-24'=c(7),'25-29'=c(8),'30-34'=c(9),'35-39'=c(10),'40-44'=c(11),'45-49'=c(12),'50-54'=c(13),'55-59'=c(14),'60-64'=c(15),'65-69'=c(16),'70-74'=c(17),'75-79'=c(18),'80-84'=c(19),'85 and over'=c(20),'total persons'=c(21))
```

```{r}
agegroup_2014 <- read_xls("data/2009_2014.xls",sheet = "Table 6") 
agegroup_2014<-agegroup_2014[-c(1:8),-c(1)]
agegroup_2014<-agegroup_2014[,-c(2:6)]
agegroup_2014<-agegroup_2014[,-c(3:4)]
agegroup_2014<-agegroup_2014 %>%
  select('state'=c(1),'LGA'=c(2),'0-4'=c(3),'5-9'=c(4),'10-14'=c(5),'15-19'=c(6),'20-24'=c(7),'25-29'=c(8),'30-34'=c(9),'35-39'=c(10),'40-44'=c(11),'45-49'=c(12),'50-54'=c(13),'55-59'=c(14),'60-64'=c(15),'65-69'=c(16),'70-74'=c(17),'75-79'=c(18),'80-84'=c(19),'85 and over'=c(20),'total persons'=c(21))
```

```{r}
agegroup_2009 <- read_xls("data/2009_2014.xls",sheet = "Table 3") 
agegroup_2009<-agegroup_2009[-c(1:8),-c(1)]
agegroup_2009<-agegroup_2009[,-c(2:6)]
agegroup_2009<-agegroup_2009[,-c(3:4)]
agegroup_2009<-agegroup_2009 %>%
  select('state'=c(1),'LGA'=c(2),'0-4'=c(3),'5-9'=c(4),'10-14'=c(5),'15-19'=c(6),'20-24'=c(7),'25-29'=c(8),'30-34'=c(9),'35-39'=c(10),'40-44'=c(11),'45-49'=c(12),'50-54'=c(13),'55-59'=c(14),'60-64'=c(15),'65-69'=c(16),'70-74'=c(17),'75-79'=c(18),'80-84'=c(19),'85 and over'=c(20),'total persons'=c(21))
```

```{r}
agegroup_2013<- read_xls("data/2008_2013.xls",sheet = "Table 6") 
agegroup_2013<-agegroup_2013[-c(1:8),-c(1)]
agegroup_2013<-agegroup_2013[,-c(2:6)]
agegroup_2013<-agegroup_2013[,-c(3:4)]
agegroup_2013<-agegroup_2013 %>%
  select('state'=c(1),'LGA'=c(2),'0-4'=c(3),'5-9'=c(4),'10-14'=c(5),'15-19'=c(6),'20-24'=c(7),'25-29'=c(8),'30-34'=c(9),'35-39'=c(10),'40-44'=c(11),'45-49'=c(12),'50-54'=c(13),'55-59'=c(14),'60-64'=c(15),'65-69'=c(16),'70-74'=c(17),'75-79'=c(18),'80-84'=c(19),'85 and over'=c(20),'total persons'=c(21))
```

```{r}
agegroup_2008 <- read_xls("data/2008_2013.xls",sheet = "Table 3") 
agegroup_2008<-agegroup_2008[-c(1:8),-c(1)]
agegroup_2008<-agegroup_2008[,-c(2:6)]
agegroup_2008<-agegroup_2008[,-c(3:4)]
agegroup_2008<-agegroup_2008 %>%
  select('state'=c(1),'LGA'=c(2),'0-4'=c(3),'5-9'=c(4),'10-14'=c(5),'15-19'=c(6),'20-24'=c(7),'25-29'=c(8),'30-34'=c(9),'35-39'=c(10),'40-44'=c(11),'45-49'=c(12),'50-54'=c(13),'55-59'=c(14),'60-64'=c(15),'65-69'=c(16),'70-74'=c(17),'75-79'=c(18),'80-84'=c(19),'85 and over'=c(20),'total persons'=c(21))
```

```{r}
agegroup_2012 <- read_xls("data/2011_2012.xls",sheet = "Table 6") 
agegroup_2012<-agegroup_2012[-c(1:8),-c(1)]
agegroup_2012<-agegroup_2012[,-c(2:6)]
agegroup_2012<-agegroup_2012[,-c(3:4)]
agegroup_2012<-agegroup_2012 %>%
  select('state'=c(1),'LGA'=c(2),'0-4'=c(3),'5-9'=c(4),'10-14'=c(5),'15-19'=c(6),'20-24'=c(7),'25-29'=c(8),'30-34'=c(9),'35-39'=c(10),'40-44'=c(11),'45-49'=c(12),'50-54'=c(13),'55-59'=c(14),'60-64'=c(15),'65-69'=c(16),'70-74'=c(17),'75-79'=c(18),'80-84'=c(19),'85 and over'=c(20),'total persons'=c(21))
```

```{r}
agegroup_2011 <- read_xls("data/2011_2012.xls",sheet = "Table 3") 
agegroup_2011<-agegroup_2011[-c(1:8),-c(1)]
agegroup_2011<-agegroup_2011[,-c(2:6)]
agegroup_2011<-agegroup_2011[,-c(3:4)]
agegroup_2011<-agegroup_2011 %>%
  select('state'=c(1),'LGA'=c(2),'0-4'=c(3),'5-9'=c(4),'10-14'=c(5),'15-19'=c(6),'20-24'=c(7),'25-29'=c(8),'30-34'=c(9),'35-39'=c(10),'40-44'=c(11),'45-49'=c(12),'50-54'=c(13),'55-59'=c(14),'60-64'=c(15),'65-69'=c(16),'70-74'=c(17),'75-79'=c(18),'80-84'=c(19),'85 and over'=c(20),'total persons'=c(21))
```

```{r}
agegroup_2014 <- read_xls("data/2009_2014.xls",sheet = "Table 6") 
agegroup_2014<-agegroup_2014[-c(1:8),-c(1)]
agegroup_2014<-agegroup_2014[,-c(2:6)]
agegroup_2014<-agegroup_2014[,-c(3:4)]
agegroup_2014<-agegroup_2014 %>%
  select('state'=c(1),'LGA'=c(2),'0-4'=c(3),'5-9'=c(4),'10-14'=c(5),'15-19'=c(6),'20-24'=c(7),'25-29'=c(8),'30-34'=c(9),'35-39'=c(10),'40-44'=c(11),'45-49'=c(12),'50-54'=c(13),'55-59'=c(14),'60-64'=c(15),'65-69'=c(16),'70-74'=c(17),'75-79'=c(18),'80-84'=c(19),'85 and over'=c(20),'total persons'=c(21))
```

```{r}
agegroup_2007 <- read_xls("data/2007.xls",sheet = "Table 3") 
agegroup_2007<-agegroup_2007[-c(1:8),-c(1)]
agegroup_2007<-agegroup_2007[,-c(2:6)]
agegroup_2007<-agegroup_2007[,-c(3:4)]
agegroup_2007<-agegroup_2007 %>%
  select('state'=c(1),'LGA'=c(2),'0-4'=c(3),'5-9'=c(4),'10-14'=c(5),'15-19'=c(6),'20-24'=c(7),'25-29'=c(8),'30-34'=c(9),'35-39'=c(10),'40-44'=c(11),'45-49'=c(12),'50-54'=c(13),'55-59'=c(14),'60-64'=c(15),'65-69'=c(16),'70-74'=c(17),'75-79'=c(18),'80-84'=c(19),'85 and over'=c(20),'total persons'=c(21))
```


```{r}
abslgadata1 <- read_csv("data/ABS_REGIONAL_LGA2017-enp1.csv")
abslgadata2 <- read_csv("data/ABS_REGIONAL_LGA2017-enp2.csv")
abslgadata <- rbind(abslgadata1,abslgadata2) %>% select(-MEASURE,-REGIONTYPE,-`Geography Level`,-LGA_2017,-FREQUENCY,-Frequency,-TIME,-`Flag Codes`,-Flags)
#unique(abslgadata$`Data item`) #Shows unique data items within abslgadata
#unique(abslgadata$Region) #Shows unique LGAs within abslgadata
glimpse(abslgadata)
```

```{r}
pop_2017<-agegroup_2017 %>%
  mutate(pop = as.numeric(pop)) %>%
  group_by(LGA) %>%
  dplyr::summarise(pop = sum(pop, na.rm = TRUE))
ggplot(pop_2017, aes(x=pop, y=LGA)) +geom_point()
```
#plot the population distribution in a map
```{r}
popdis_2017<-full_join(pop_2017, LGA, by=c("LGA"="LGA")) %>%
  filter(!is.na(lat), !is.na(lon), !is.na(pop))
vic <- get_map(location = c(144.9631, -37.8136), zoom=14)
ggmap(vic) +geom_point(popdis_2017, aes(x=lon,y=lat,colour=pop), size=4, alpha=0.7)+
  scale_colour_distiller(palette="YlOrRd")
```


#plot the rental prices distribution in a map
```{r}
rent2017<-filter(all_medianp, year=="2017") %>%
  mutate(values=as.numeric(values), Suburb=as.factor(Suburb)) %>%
  group_by(Suburb) %>% dplyr::summarise(n = median(values, na.rm = TRUE)) %>%
  mutate(LGA=as.character(Suburb)) %>%
left_join(LGA, by="LGA") %>%
  select(LGA, n, lat, lon) %>%
  filter(!is.na(lat),!is.na(lon))
vic <- get_map(location=c(144.9631, -37.8136), zoom=14)
ggmap(vic) +geom_point(aes(x=lon,y=lat,colour=n), size=4, alpha=0.7)+
  scale_colour_distiller(palette="YlOrRd")
rent2017
```
#combine the population and rental prices distribution 
```{r}
price_year<-all_medianp %>%
  mutate(values=as.numeric(values), year=as.character(year)) %>%
  group_by(year) %>%
  dplyr::summarise(n=median(values,na.rm = TRUE)) %>%
  mutate(year=as.numeric(year))
p1<-ggplot(price_year, aes(x=year,y=n), alpha=0.9, size=3) +
  geom_line() +
  xlab("year") +
  ylab("median rental price")
pop_year <- read_xlsx("data/population-vic.xlsx")
p2<-ggplot() +
  geom_line(data=pop_year,aes(x=year,y=n)) +
  xlab("year") +
  ylab("total population in victoria")
p1
p2

```
Overall, both population and rental price have increased siginificantly over the past ten years. They are positively correlated. 




```{r}
price_year<-price_year %>%
  mutate(factor="rent") %>%
  filter(!(year %in% c("1999","2000","2001","2002","2003","2004","2005","2018"))) %>%
  mutate(pct_change=(n/lag(n) - 1) * 100) %>%
  filter(!is.na(pct_change))
pop_year<-pop_year %>%
  mutate(factor="population", pct_change=(n/lag(n) - 1) * 100) %>%
  filter(!is.na(pct_change))
pop_price<-bind_rows(pop_year,price_year)
ggplot(pop_price,aes(x=year,y=pct_change,fill=factor)) +
  geom_bar(stat = "identity",position="dodge") + 
  geom_line()
scale_fill_brewer(palette="Dark2")
```
####
According to the bar chart, the growth rate of total population in victoria has kept stable compared with the rent change, which has flutuated remarkably over the past decade. Basically, the slight movement of population growth rate in victoria would result in remarkable changes in rental growth. To be more specifit, if there would be a increase in the population, the rental price would increase significantly in victoria, normally it would be reflected one year later, after the change of the population. For example, the growth rate of population peaked at 2008, and then it kept declining for the next three years. While, in terms of rental price, it rocked to 9.09% in 2008 and decreased considerablly in the following five years, which means that the movement of the population would signifiantly affect the change in the median rental price in victoria.     

```{r}
mod<-lm(price_year$pct_change~pop_year$pct_change)
library(broom)
tidy(mod)
glance(mod)
```
According to the table, percentage change in rental price each year is negatively related with that of population, since the coefficient is negative. In regard to R-square, it shows 6.54% variations in growth rate in rental price are explained by the growth rate in population. 

=======
get_distance = read_csv('data/LGA_Profile_2014_beta.csv')
get_distance <- get_distance[,c(2,9)]
get_distance <- get_distance %>% separate(LGA, sep = "[()]",c("LGA","index"))

get_distance$LGA <- trim.trailing(get_distance$LGA)
get_distance <- get_distance[,-2]
glimpse(get_distance)

loc_2018_added_dis <- left_join(loc_2018,get_distance,by = "LGA")

p <- ggplot(loc_2018_added_dis, aes(x=Distance_to_Melbourne_in_km, y=values,label = LGA)) + geom_point() + ylab("Rental Price") + ggtitle("Price changed by distance to Melbourne CBD in 2018")

ggplotly(p)
>>>>>>> eef71a3b2db5e21cfbd82bb67a8d2617180af088
```

